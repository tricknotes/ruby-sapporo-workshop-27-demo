<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>

  <script>
    Account = Ember.Application.create();

    Account.IndexRoute = Ember.Route.extend({
      model: function() {
        var sheet = Account.Sheet.create({
          lines: [
            Account.OrderLine.create(),
            Account.OrderLine.create()
          ]
        });

        return sheet;
      }
    });

    Account.SheetsRoute = Ember.Route.extend({
      model: function() {
        return Account.Sheet.sheets;
      }
    });

    Account.Router.map(function() {
      this.resource('sheets');
      this.resource('sheet', {path: '/sheet/:id'});
    });

    Account.Sheet = Ember.Object.extend({
      lines:     [],
      createdAt: null,

      id: function() {
        return Account.Sheet.sheets.indexOf(this) + 1;
      }.property('Account.Sheet.sheets.length'),

      total: function() {
        return this.get('lines.@each.subtotal').reduce(function(total, subtotal) {
          return total + (subtotal || 0);
        }, 0);
      }.property('lines.@each.subtotal')
    });

    Account.OrderLine = Ember.Object.extend({
      productName: null,
      unitPrice:   0,
      count:       0,

      subtotal: function() {
        return this.get('unitPrice') * this.get('count');
      }.property('unitPrice', 'count')
    });

    Account.Sheet.sheets = [];

    Account.IndexController = Ember.ObjectController.extend({
      actions: {
        addOrderLine: function() {
          this.get('lines').addObject(Account.OrderLine.create());
        },

        deleteOrderLine: function(orderLine) {
          this.get('lines').removeObject(orderLine);
        },

        addSheet: function() {
          var sheet = this.get('model');

          sheet.set('createdAt', new Date());
          Account.Sheet.sheets.addObject(sheet);

          this.transitionToRoute('sheets');
        }
      }
    });
  </script>
</html>
